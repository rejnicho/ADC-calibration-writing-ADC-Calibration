\documentclass[11pt, letterpaper]{article}
\usepackage[margin=1.75cm]{geometry}    
\usepackage{graphicx}
\geometry{letterpaper}

\title{Calibration of Analog to Digital Converters with Considerations from DNL and INL}
\author{Renee Nichols, }
\date{August 2024}

\begin{document}
\maketitle 

This work outlines a way to calibrate the analog to digital converters (ADC) using a differential nonlinearity informed method. 
Specifically, this method was developed for use in Rubin Observatory's LSSTCamera, but could be extracted to other uses of ADCs. 
This method showcases the individual periodic structure of each ADC by examining the long range behavior over the range of the ADC. 
We see that the method developed, so called "cumulative binning", here allows for a calibration that falls within the specifications from the manufacturer, including no unbounded integral nonlinearity and differential nonlinearity that does not deviate from expectation. 
This method provides robust results using two different types of runs from two different portions of electric-optical testing of the LSSTCam, suggesting the calibration can be conducted on various testing data.
Together this demonstrates the stability of the ADCs through time for every amplifier's ADC, and yields the ability for the calibration to be extracted for future work.

\section{Motivations}
\label{sec: Motivations}
\indent

 
Understanding the analog to digital converters shares information about how the electronics are working within the system and thus an understanding of the signal received by the telescope from the the sky, which is crucial to all four science themes as put forth by the LSST Science Book (Ivezic et. al. 2019). 
Since the gain is known between the CCD and the ADC, one can use the calibration of the ADC to directly map a signal back to incident photons or electrons on down to an amplifier level.
Rubin Observatory’s LSSTCam uses 18-bit analog to digital converters to record the signal from the bias level all the way through saturation of the silicon charge coupled device (CCD) sensors that make up the focal plane. 
We seek to understand the relationship between input signal into the ADC and the output ADU across all amplifiers on the focal plane, over 3000 amplifiers, and verify the specifications set by the manufacturer. 
This is largely motivated by a previous method to calibrate the ADCs which resulted in an unbounded integral nonlinearity (INL) and calculated INL and DNL dependence on the starting bin.
Knowledge of the specified differential nonlinearity (DNL) did not indicate these feature should be present, suggesting a need for a more accurate calibration to be constructed and suspicion these features were arbitrary introduced. 

\indent 
In the following sections we will examine these issues in the following way.
We will begin by defining DNL and INL, then develop our cumulative binning method, and finally examine the results of these calibrations in context of the expectation for these electronics. 
We then wrap up the discussion with a demonstrative example of how to use the result developed here, and leave more notes to the reader on pitfalls to creating a robust calibration in the appendix. 

\begin{figure}
    \centering
    \includegraphics[width=0.5\linewidth]{dnlinlex.pdf}
    \caption{Above is a schematic demonstrating how the analog to digital converter ideally works (blue), and its true behavior (orange). Along the y axis is the ADU value recorded by the ADC, which has integer values. Along the x axis is the edge of the ADC, or the left and right edges of the bin which maps to a given ADU. As tracked along the blue curve, an ideal ADC has bins with integer edges which map to corresponding ADU. Typically the incident input is some amplified voltage, where the gain of such amplification is known. The orange curve shows a simulated true ADC, which has left and right edges that deviate from the ideal, but still maps to a single ADU. The difference in the left and right edges leads to the presence of a differential nonlinearity, a difference between an ideal bin width and a true bin width, and also an integral nonlinearity, a difference between an ideal middle of a bin, and a true middle of a bin.}
    \label{fig:idealADC}
\end{figure}

\subsection{Definition of Differential and Integral Nonlinearity}
\label{sec: DNL_INL_Def}
\indent 


The analog to digital converter’s purpose is to convert an analog signal (typically a voltage) to a digital one that can be readout and stored for further use. 
The output signal is measured in analog to digital units (ADU). 
The input signal has limits, called edges, which maps input voltage range into the stated ADU value. 
These edges have a lower bound, called the left edge, and an upper bound, called the right edge.
The difference between the right edge and the left edge determines the width of the bin itself, and is determined through the process called calibration of the ADC. 
As seen in figure \ref{fig:idealADC}, in a perfect ADC (blue) the bins have a width of exactly 1 ADU, and are spaced integers apart from one another. 
That is a voltage 0-0.9 would be 0 ADU, 1.0-1.9 is 1 ADU, and so on. 
Yet in a true ADC (orange), bins may differ from the ideal bin width of 1 ADU, and have non integer left and right edges mapping to specific ADU values. 
As shown in figure \ref{fig:idealADC}, voltage 0-1.2 would be 0 ADU, 1.3-1.8 1 ADU, and so on. 
\indent 


The presence of deviations from an ideal ADC in terms of bin widths leads to two types of nonlinearities: differential (DNL) and integral (INL) nonlinearity. 
DNL is the deviation of a bin's width from that of an ideal bin width and is defined exactly as
\begin{equation}
DNL =1- w  
\label{eq: DNL}
\end{equation}
where w is the width of a bin. 
This value is computed for all bins along the ADC. 
Values of the DNL are typically on the order of $\pm$ 0.5, and any value greater than $\pm$ 1 could indicate a skipped bin. 
To the accuracy of the ADCs used for the LSSTCamera, no missing codes are stated to be baseline.
\indent


Integral nonlinearity is the deviation of the middle of a bin from that of an ideal bin, which is denoted 
\begin{equation}
INL = m_{ideal} - m_{adc} 
\label{eq: INL}
\end{equation}
where $m_{ideal}$ is the midpoint of an ideal bin, and $m_{adc}$ is the midpoint of an ADC bin. 
INL typically yields contributions from each bin on the order of $\pm$ 1, with deviations above 2 being out of specification (AD7982, 2020). 
As in figure 1 the first bin's DNL = 1.2-1 = 0.2, while its INL = 0.5-0.6 = -0.1. 
\indent


These nonlinearities act as parameters to help understand the signal coming from the ADC and should be examined to see if any patterns emerge as structure along the edges. 
For instance, a local portion of the ADC with DNL could also induce some local INL, simply by construction of their definitions.
While this may be expected, changes in one type of nonlinearity but not the other may signal an issue in the calibration or in the ADC itself.
We will examine any structure that is present through our calibration, especially nonlinearity outside of the expectation for the ADCs. 


\subsection{Runs, Distributions, and Filters}
\label{sec: RDF}
\indent

Calibration of the ADC involves using signal from the CCD over its range, from bias through saturation, which is mapped to roughly 100k ADU. 
The CCDs collect charge as a function of how much light is incident on the sensor, meaning any one image could only show some small subset of the range of the CCD and therefore only an equally small subset of ADU.
To cover the range of the ADC, a large number of exposures are needed to represent the range of the CCD. 
For our use case of the LSSTCamera, we utilize collections of test exposures called runs as collected through electro-optical testing. 
Each run has a defined purpose and we choose a run with data we declare suitable. 
The first of these runs is 13144, which is over 600 exposures of flat pairs with exposures covering bias to saturation of the CCDs. 
When compiled into a single histogram, in counts per ADU, we can look at the distribution of codes represented by the ADC.  

\begin{figure}
    \centering
    \includegraphics[width=0.5\linewidth]{bar1.pdf}
    \caption{Above is the combined distribution of the readout from all pixels on a single amplifier, R22S00C01, along all 687 flat pair exposures taken in run electro-optical testing run 13144. The distribution demonstrates there is a much greater density of exposures in the sub 30,000 ADU region, yielding a distribution with counts more than two orders of magnitude greater than later regions of the ADC. Another feature is the present spike around 50,000 ADU, which is also due to a higher density of exposures with corresponding exposure time in that region. A third notable feature, is the oscillatory peak-like behavior throughout the range of the ADC. This is due to the exposures themselves having a bell curve distribution of ADU and is the result of adding many such exposures together. The upper right hand corner zooms in on one such peak, showing that bin to bin there are small deviations of counts present as well as some patterned downticks every 128 counts, as discussed further in Section \ref{sec:results}.}
    \label{fig:unscaled13144}
\end{figure}

Figure \ref{fig:unscaled13144} demonstrates one such combined distribution, which yields fluctuations over the range of the ADC in terms of how much signal is present bin to bin. 
The bin to bin deviations are two fold. 
The most present is the skew of the signal to low ADU which is the result of more low exposures time images in this run which is due to the intended purpose of this run. 
There are also local deviations which denote the presence of DNL. 
In order to understand how we would expect an ideal ADC to work, we want to preserve the long range behaviors of the full distribution, while minimizing any bin to bin deviations. 
This is accomplished by using a filter, in this case a Savitizy-Golay filter.
Additional filter choices are also examined in the appendix. 
As seen in figure \ref{fig:filterunscaled13144}, over the range of the ADC the filter smooths between the bin to bin, while preserving the behavior over the long range. 
In the method outlined in section \ref{sec: Cummulative binning}, the resulting distribution from the filter is taken to model the distribution if the ADC behaved ideally. 
We seek to characterize the resulting DNL and then place the ADC edges to be able to understand the incident signal to the CCDs. 

\begin{figure}
    \centering
    \includegraphics[width=0.5\linewidth]{bar2.pdf}
    \caption{Above is the combined distribution of the readout from all pixels on a single amplifier, R22S00C01, along all 687 flat pair exposures taken in run electro-optical testing run 13144 as seen in figure \ref{fig:filterunscaled13144}. Overlayed in orange is the output from a Savitzky-Golay filter with window size 65, and order 3. As seen more clearly in the zoomed upper righthand corner, there are deviations between the filter and the histogram throughout the range of the ADC which directly demonstrates presence of differential nonlinearity. One can also see from this that the filter follows the long range behavior of the ADC, while still smoothing over bin to bin deviations present in the histogram itself.}
    \label{fig:filterunscaled13144}
\end{figure}

\subsection{Run Preparation}
\label{sec: Preparation}
\indent


As discussed in section \ref{sec: RDF}, the ADC covers a range of 100,000 bins, with some expected distribution of signal to fall into each of these bins. 
In a more specific treatment this distribution, called the probability distribution function, informs how much is present in each of the bins.
That is how many pixels on the amplifier will yield a specific ADU value.
We have no a-priori knowledge of this distribution and instead need to infer it from the signal from the ADC.
As determined using the calibration method in section \ref{sec: Cummulative binning}, the shape of the distribution over the range of the ADC plays a large role in the parameters such as the DNL and INL.
Thus utilizing a distribution where there is a large amount of exposures in a single region and few in another, creates small bins (on average) with large DNL and an unstable (bin starting dependent) INL. 
In order to calibrate the ADC successfully then, we need a distribution where all portions of the ADC are equally represented, otherwise we are introducing features and substructure of the ADC that simply do not exist
We will term this requirement for the distribution "relative flatness". 
\indent 


This implies that we have two criteria for calibration, relative flatness and the full range of the ADC. 
Yet our data come in the form of exposures from EO Runs, and signal in the ADC is proportional to the amount of light incident on the sensor. 
This implies many exposures, with many different amounts of light is necessary to cover the full range of the ADC. 
Although, as seen from figure \ref{fig:unscaled13144}, using all exposures equally in a run may yield a distribution where some regions are over or under represented. 
Therefore we need to determine the groupings of exposures that demonstrate the distribution of signal over the entire ADC. 
A run of images with increasing exposure time and continuous readout would satisfy this requirement, as we could see how the ADC responds over the full range of the CCDs. 
This was completed during Run 6b of EO Testing as run 13549 which we call a "ramp" run and is shown in figure \ref{fig:filter13549}.
While this data is very useful for this calibration it is not always practical to request a special run set of exposures given the time necessary for the run.
Instead it is beneficial to be able to also use flat pair runs, such as run 13144, which still record exposures from bias to saturation of the ADC but in a nonuniform way.
To utilize these runs we use a dynamic pre-scale to select portions of all exposures to include in the combined pseudo-flat distribution. 

\begin{figure}
    \centering
    \includegraphics[width=0.5\linewidth]{bar13549.pdf}
    \caption{Above is the combined distribution of the readout from all pixels on a single amplifier, R22S00C01, along all 234 ramp exposures taken in electro-optical testing run 13549. Overlayed in orange is the output from a Savitzky-Golay filter with window size 33, and order 3. Over the range of the ADC, the signal in all bins remains relatively consistent. Yet near the saturation there is a large peak in the distribution which is discussed in detail in section \ref{sec: Cummulative binning}. In the upper lefthand portion of the plot is a zoomed in section of the ADC demonstrating the oscillatory nature of the distribution as well as the deviations between the filter and the distribution, a sign of the DNL present in the ADC.}
    \label{fig:filter13549}
\end{figure}


The pre-scale method combines portions of all the exposures from a flat pair run into a combined distribution which is relatively flat over the entire range of the CCD. 
In practice we examine the region of the ADC where the combined signal is relatively flat, typically higher ADU codes, and select the saturation level for the entire distribution. 
For run 13144 we used 5000 counts per ADU. 
 We then compute a pre-scale factor, $\chi _i$, for each 25 ADU subregion of the ADC, where
\begin{equation}
\chi_i = \frac{5000}{c_{av}}
\label{eq: prescale}
\end{equation}
where $c_{av}$ is the average observed counts from the combined histogram over the subregion. 
For any regions of the ADC where the $c_{av} < 5000$ the pre-scale factor was taken to be 1, or all data in that region was used for the combined distribution. 
\indent 


Each exposure is then pulled and its peak signal in ADU is matched with the corresponding pre-scale factor. 
Then the number of samples to select from that exposure, denoted as $\eta $, is determined via
 \begin{equation}
 \eta = \chi_i *n 
 \label{eq:selectedsamples}
\end{equation}
Where the number of pixels in the amplifier, n, is dependent on the type of CCD attached to that ADC, either an E2V or ITL from the two manufacturers of the CCDs. 
A randomization process selects $\eta$ pixel digitizations from the exposure, and these are added to the combined distribution. 
This is repeated for each exposure in the run, and builds a pseudo-flat distribution over the full range of the ADC while keeping the behavior in each exposure. 
The resulting distribution is shown in figure \ref{fig:scaled13144}. 

\begin{figure}
    \centering
    \includegraphics[width=0.5\linewidth]{bar13144.pdf}
    \caption{Above is the pre-scaled combined distribution of the readout from all pixels on a single amplifier, R22S00C01, along all 687 flat pair exposures taken in electro-optical testing run 13144, the unscaled version is Figure 3. The pre-scaling process is outlined in section \ref{sec:PDFEdges}. Oscillations can be seen throughout the histogram, which are the result of the exposures used to create this combined distribution. Overlayed in orange is the output from a Savitzky-Golay filter with window size 33, and order 3. The deviations between the filter and the histogram directly demonstrates persistence of differential nonlinearity in the ADC still present despite the rescaling.}
    \label{fig:scaled13144}
\end{figure}

\section{Cumulative Binning Calibration}
\label{sec: Cummulative binning}
\indent


After examining the previous method of calibrating the ADC, detailed in the appendix, a need existed for a calibration of the ADC that represents the ADC without inputting fabricated INL or DNL. 
In this new calibration method we will still use entire runs, but selectively prepare the distribution of counts over the range of the ADC as detailed in section \ref{sec: Preparation}. 
The formal definition of the filter is expanded to include a probability distribution function (pdf) to illustrate the distribution of counts along the ADC. 
We will then use all this to construct the bin edges along the full range of the ADC. 
Embedded is also discussion of removal of particular bins, protection of the distribution from the filter, and other aspects crucial to calibration, as well as discussion of where to find a version of code used in this work.



\subsection{PDF definition and determination of ADC edges} 	
\label{sec:PDFEdges}
\indent

Here we develop a new calibration process using the understanding of $\varrho$, the probability distribution function (PDF) in relation to our signal in ADU as mentioned in section 1.3. 
Each bin of the ADC will have counts which are the integral of the pdf, from the left edge of the bin to the right edge of the bin described as
 \begin{equation}
c_o =  \int_{l}^{r} \varrho dx
\label{eq:pdfcounts}
\end{equation}
where l is the left edge of the ADC, r is the right edge. 
There is also a relationship between the filtered distribution values and the PDF,
 \begin{equation}
f_i =  \int_{i}^{i+1} \varrho dx
\label{eq:pdffilter}
\end{equation}
where $f_{i}$ is a filtered output per $ADU_{i}$. 
The filtered value is equivalent to the integral of the pdf from the integer left to right edges of the pdf over a region of width 1. 
In this calibration we use a Savitzky-Golay filter with a window size of 33 and order 3. 
Further filter choices can be found in the appendix. 
Using this description of the filter, we can utilize the fundamental theorem of calculus via cumulative sums, to examine how an integral of the pdf behaves over larger regions of the ADC. 
 \begin{equation}
\sum_{i=0}^{j} f_i= \int_{0}^{j+1} \varrho dx
\label{eq:fidef}
\end{equation}
Since our ultimate goal is to determine the edges of the ADC, r and l in equation \ref{eq:pdfcounts}, we need to interpolate non-integer values of these integrals. 
This is done by fitting a cubic spline, $ \zeta$, to the cumulative sum, which allows us to evaluate the integral of the PDF with non integer end points, representing the true edges of the ADCs. 
Mathematically, we decompose the integral of the observed distribution to be:
 \begin{equation}
c_o = \zeta(r) - \zeta(l)
\label{eq:countsspline}
\end{equation}
Rearranging eq. \ref{eq:countsspline}: 
 \begin{equation}
c_o + \zeta(l) = \zeta(r)
\label{eq:splineright}
\end{equation}
Given the choice of using the first left edge to be our earliest populated bin and $c_{o}$ is described in section \ref{sec: RDF}, we then utilize equation \ref{eq:splineright} to determine the right edge.
In our method, we first assume a width of 1 and determine how close the value matches that of expected. Then if the right edge is too small/large we increase/decrease the bin size by a standard amount and recheck the value. 
This process is repeated until a convergence interval is reached, typically $\pm$1 count. 
See the appendix for further information about the convergence criteria. 
Altogether this yields a calibration of a single amplifier's ADC in under 10 seconds, without making any calculation or assumptions about the DNL and INL.


\subsection{Additional Considerations} 
\label{sec: AD}
\indent 


Through developing this calibration, some issues arose which required attention in order for the calibration to not fail. 
We detail a number of these in this section, which may allow for reconstruction of this method. 
\indent 
The first of which involves the implementation of the spline of the cumulative sum as described in Section \ref{sec:PDFEdges}. 
The spline utilized in this method is a cubic function. 
Due to this, it has the potential to interpolate and yield a negative values, specifically it was noted that this occurred at the low ADU region of the distribution. 
We note that negative values from the spline are nonphysical solutions, as a region of the ADC can only yield 0 or a positive number of counts. 
In order to protect the spline from this, we use padding, or adding more bins with 0 counts before where our ADC first has recorded signal in bins. 
This inherently protects the spline from yielding negative values, as the function is forced through 0. 
\indent 

A second consideration is the depth of bins to include in the entire distribution. 
We caution against including, in our use case, bins of low ADU which are sparsely populated as they may represent Poisson noise rather than true signal. 
In our calibration, we remove any bin with less than 100 counts, which are bins with signals that are 1/50 of a typical bin (as seen also in the prescale preparations in section \ref{sec: Preparation}). 
This protects the calibration from exceptionally small bins due to noise.
\indent

Due to the removal of bins from the distribution, we need to examine whether the combined distribution yields any locations along the ADC with a skipped bin. 
We denote a skipped bin is an ADU with no signal recorded in the source histogram, and would result in a specific ADU not represented in the calibration. 
These skipped bins could either be from the removal as previously discussed, or inherent to the combined distribution. 
Since the specifications sheet by the manufacture guarantees no skipped bins, any ADC with a missing bin should be accordingly flagged. 
As a safeguard for our calibration, we flag any skipped bins, and recommend the calibration begins after a skipped bin. 
It should be noted here that our distributions did not have any skipped bins due to exposures themselves, but had some in early ADU due to the selection cut previously discussed. 
As an additional precaution, our method returns the location of the first bin, the first left edge, in order to compare when the calibration commences. 
This not only preserves the behavior of the ADC, but prevents the accidental termination of the method or interpolation over a bin with insufficient data for calibration. 
\indent 


The last two concerns in this process occur only for run 13549.  
The full distribution on some amplifiers demonstrate "peak" behaviors either near the bias or saturation of the CCD, or both.
Figure 5 demonstrates one of such peaks, a peak near the saturation.  
These peaks have finite widths, suggesting more is going on beyond a "pile up" binning error in the histograms of the exposures. 
This was troubling to observe, as the distributions in most amplifiers did not have this, and there seemed to be no correlation between amplifiers with this feature, and those without. 
It became essential to terminate the distributions with these peaks to exclude them from the edge calibration, due to known INL/DNL injection from peaked sources as discussed in the appendix. 
Termination excluded all bins within a range of 50 of the peak, effectively about 100 bins were removed per observed peak. 
This is less than 1 percent of the data and prevents synthetic INL and DNL injection, while still allowing calibration for the majority of the ADC. 
In the case of figure \ref{fig:filter13549}, with a peak near the saturation, this meant the edge method stops before reaching where the saturation is achieved, and instead makes edges over the region in the main part of the distribution. 

\subsection{GitHub Access}
\label{sec: Git}
\indent 


To access a version of the code which produced these results, use the GitHub repository rejnicho/
Focal-Plane-DNL-adc-Calibration, and follow the three step process to access the data, calibrate the ADCs, and create the comparison plots shown in section \ref{sec:results}. 

\section{Results}
\label{sec:results}
\indent


Utilizing the calibration process of the ADC as described in section \ref{sec: Cummulative binning}, we are able to calibrate all 3024 non-corner ADCs on the LSSTCam focal plane using both runs 13144 and 13549. 
For each individual amplifier’s ADC we can see the substructure of the ADC, figure \ref{fig:substructureplot}, by looking at the individual bins and their widths as a function of their location along the ADC. 
We can see the presence of any structure in the distribution itself, including the downticks present every 128 counts along the ADC. 
The downticks present in this amplifier are not observed in all amplifiers, although the substructure in the form of macroscopic groupings of the DNL can be seen in all amplifiers.
This suggests that the real behavior of the ADC is recovered through the method developed in section \ref{sec: Cummulative binning}, and is present regardless of the type of data used in the calibration.
Even though as figure \ref{fig:substructureplot} demonstrates, the calibrating distribution plays a role in the exact locations of the bin widths over the ADC, there is no statistical evidence via a Paired T Test that the width difference deviates from zero between the two runs.  
Also seen in figure \ref{fig:substructureplot}, there are some noticeable differences in the locations of the edges of the ADCs when depending on whether run 13144 or 13549 was used for the calibration.
We examine the locations of the left edge in more detail, and determined that R22S00C01 has left edges that differ on average by 0.2 ADU per bin. 
This suggests there is a systematic shift of the left edges depending upon the distribution used in the calibration.
Given there is no difference in the widths between the two runs nor any systemic differences in INL and DNL, this suggests that there is a slight offset of the binning depending on the calibrating run.
This means the widths created by both runs yields consistent calibrations of the ADC. 

\begin{figure}
    \centering
    \includegraphics[width=0.5\linewidth]{substructure.pdf}
    \caption{The above figure demonstrates the calibrated bin widths of the the amplifier R22S00C01, near the lowest ADU region. At this zoom level, the substructure of the ADC can be seen clearly. On the left is the result from the ramp run 13549, and on the left is the result from the pre-scaled run 13144.  Some slight deviations can be seen between the two runs, due to their individual distributions, but both demonstrate regions of macroscopic grouping of DNL and yield similar bin for bin values of the DNL, as explained in section \ref{sec:results}.}
    \label{fig:substructureplot}
\end{figure}

Beyond a single amplifier, we can further look at the entire focal plane, and the edges made for each of the ADCs. 
For the sake of space, we show just the calibration of 13549 over the entire focal plane. 
Figure \ref{fig:focalplaneDNL} demonstrates the absolute value maximum DNL for all bins for every ADC on the focal plane. 
The DNL falls within the allowable 0.85-1.5 range as set by the manufacturer.  
Figure \ref{fig:focalplaneINL} demonstrates the absolute value maximum INL for all bins for every ADC on the focal plane. 
The INL falls within $\pm$ 2 for every ADC. 
This suggests we have all the ADCs within the specifications set by the manufacturer, and the same result was noted for 13144 although plots are not included. 

\begin{figure}
    \centering
    \includegraphics[width=0.5\linewidth]{maxdnlplot.pdf}
    \caption{The above figure demonstrates the calibration of the ADC using the differential nonlinearity method we described in section \ref{sec: AD}. This method computes edges along the ADC for each 3024 amplifiers individually. The DNL can then be computed for each bin, in each amplifier, and plotted here is the maximum magnitude DNL of all bins in each amplifier. Ranging in magnitude between 0 and 1, the maximally achieved DNL for each amplifier is below the maximally allowed by the specification sheet.}
    \label{fig:focalplaneDNL}

\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=0.5\linewidth]{13549maxinl.pdf}
    \caption{The above figure demonstrates the calibration of the ADC using the differential nonlinearity method we described in section \ref{sec: AD}. This method computes edges along the ADC for each 3024 amplifiers individually. The INL can then be computed for each bin, in each amplifier, and plotted here is the maximum magnitude INL of all bins in each amplifier. Ranging between 0 and 2, the maximally achieved INL for each amplifier is below the maximally allowed by the specification sheet.}
    \label{fig:focalplaneINL}
\end{figure}



\indent

We note, although it is not explicitly shown, that the issues of instability of the DNL and INL, as discussed in and the appendix are no longer present. 
This implies we are able to calibrate the ADC regardless of the commencing bin. 
This suggests that using a pre-scale on a flat pairs run works just as well for this DNL calibration of the ADC as using a ramp run. 
An additional aspect is noted in the stability of our electronics through time, meaning the ADCs are delivering consistent binning results from December of 2021 to November of 2023. 
This is highly beneficial as the survey length of LSST is 10 years, and changing binning of the ADCs may prove troublesome. 
As seen in section \ref{sec:Future}, this method allows the conversion of bin edges from integer to real values, allowing for greater precision in measurements used for many science cases. 

\section{Future Work}
\label{sec:Future}
\indent

The work presented in this document outlines the ability to calibrate each of the amplifiers's ADC individually on the LSSTCam focal plane. 
This means there is a great understanding on the conversion between the digital signal incident into the ADC and the output signal recorded. 
Knowing this, we are able to reverse engineer and understand the meaning of the measurements taken by the camera. 
That is, an ADU value can be mapped exactly back it to its input digital signal in real values, rather than generalized integers.
In the language of this work, the ADU is mapped back to the edges [l, r] rather than being located within [ADU, ADU+1].
This specifically states what the voltage responsible for the ADU value is. 
In turn, since other work explicitly states the gain from all the electronics between the CCD and the ADC we are able to convert the ADU signal directly back to electrons incident on the sensor.
Functionally, utilizing this calibration is rather quick. 
Given the calibration as developed in section 2 for a specific amplifier, a list of bin edges would exist, with the first edge being the first ADU in the calibration, we denote here as $ADU_{start}$.
That means for any measurement on that amplifier, the output ADU is simply:
 \begin{equation}
ADU_{measurement} = ADU_{start} + index 
\label{eq: ADU}
\end{equation}
Where $ADU_{measurement}$ is the measurement taken, and index is the integer amount from the start of the calibration the measurement is. 
Therefore, to determine the true voltages of the ADC, one takes the index element of the list for the minimum voltage, and the index + 1 element of the list for the maximum voltage. 
\indent

Below is a worked example to illustrate the use case of turning bin edges from integers to real values. 
I have a measurement of 56,049 ADU on R22S00C01 and I would like to know the true input voltages. 
The first bin in this calibration is 26,720, so the index I am interested in is 56,049-26,720 = 29,329. 
To find the lower bound voltage I take edges[29329] = 56,048.86 and the upper bound to be edges[29329+1] = 56,049.65
Thus the true signal is within [56,048.86, 56,049.65]. 
I could then take either the left edge or the middle to be the true voltage of this ADU, depending on user preference, and now we can utilize the gain to find the true number of incident photons on the sensor. 
In turn this allows this result to have direct impacts for science as a more precise number of electrons can be used and compared across amplifiers. 

\section{References}
\label{sec:Ref}

Ivezic, et al., 2019, ApJ, 873, 111.

18-Bit, 1 MSPS PulSAR ADC in MSOP/LFCSP. AD7982. 2020. 

\section{Appendix}
\label{sec:appendix}
\indent

In this section we detail more methods and processes attempted during the development of the calibration process discussed in this work. 
The work detailed here contributed greatly to the development of the cumulative binning method but fails to create a successful calibration as detailed here.
\indent

\subsection{First Pass DNL ADC Calibration}
\label{sec:Adrianmethod}
\indent


This section details a DNL informed ADC calibration which was developed by A. Shestakov, which is a starting point for the work described in section \ref{sec: Cummulative binning}. 
Using run 13144, as shown in figures \ref{fig:unscaled13144} and \ref{fig:filterunscaled13144}, a Savitizy-Golay filter with a window of 65 and order 3 was used to model an ideal ADCs behavior. 
The DNL of each bin was then computed, using the reformualization of the DNL via 
 \begin{equation}
 DNL = \frac{c_e}{c_o}
 \label{eq:dnlfrac}
 \end{equation}
where the $c_{e}$ is the expected number of counts from the filter, and $c_{o}$ is the observed number of counts from the true distribution. 
Equating equation \ref{eq: DNL} with equation \ref{eq:dnlfrac} we yield an equation for the widths along the ADC as
 \begin{equation}
 w = 1-DNL = 1- \frac{c_e}{c_o}
 \end{equation}
Assuming the first left edge correspond to the first ADU with signal, the edges of the bins were placed accordingly as
 \begin{equation}
r = l + w 
\end{equation}
where r is the right edge and l is the left edge. 
This allowed the calibration of the ADC over a range of approximately 26-100k ADU, which is roughly bias through saturation of the CCD.  


\subsection{Differential and Integral Nonlinearity Results}
\label{sec:DNLINLIssues}
\indent


The original method, as discussed in the previous section \ref{sec:Adrianmethod}, yields a calibrated ADC where both INL and DNL have deviations from specification. 
Here we will break down the nonlinearities independently to parse where they come from in this calibration. 
The left side of figure \ref{fig:originalDNLINL} demonstrates the DNL as computed using this method from earliest possible bin. 
One can clearly see that for low ADU there are many large, greater than $|0.5|$ ADU DNLs, yet later on the DNL falls within a more expected range. 
This translated into early bin widths being very narrow while later bins are much wider. 
We break the reasoning for this phenomena into two parts. 
The first is the indication that the filter itself struggles to characterize a true ADC for low ADU.
That is the $c_{e}$ are small on average early on. 
This is confirmed to disappear when the filter is started later in the flatter portion of the distribution, suggesting there is a distribution based issue for the filter fitting. 
The appendix notes some chi square tests to examine how closely the distributions align for different starting locations and filter types. 
The second aspect is the signal difference in the two regions. 
This signal is on the order of one million near bias and approximately five thousand near saturation, which is multiple orders of magnitude difference over the range of the ADC.
Together this notes the parameters window size should be changed to match the incident distribution more closely but also a more flat distribution should be used where the density of ADU is more consistent over the ADC.
We will see in section \ref{sec: Cummulative binning} that changing filter type and clever use of the combined distribution has this DNL issue resolved. 
\indent 


There is also structure in the INL resulting from this method described in section \ref{sec:Adrianmethod}.
The right plot in figure \ref{fig:originalDNLINL} demonstrates unbounded INL over the range of the ADC, with a maximum deviation of over 140 ADU. 
Clever cuts to the distributions successfully lowered INL contributions to 10 ADU, but reduced the range of the calibration significantly to cover a range of about 30,000 ADU. 
This suggested that no amount of clever cuts would be able to coax both the INL and DNL into specifications. 
Another notable dependence arose between the starting bin and the maximum magnitude INL contribution achieved over the calibration. 
This is examined more closely in the appendix, but it is noted that a shift of 1 ADU in starting location could result in maximum INL change of over 100 ADU over the range of the calibration. 
Together these issues with INL and DNL indicate the need for a more robust treatment of the calibration method, a successful attempt will be outlined in section \ref{sec: Cummulative binning}.


\begin{figure}
    \centering
    \includegraphics[width=0.5\linewidth]{inldnl.pdf}
    \caption{Above on the left demonstrates the contributions to the differential nonlinearity using the method described in \ref{sec:Adrianmethod} for amplifier R22S00C01. For sub 30000 ADU, the DNL sharply peaks, suggesting reason for concern, while the DNL stabilizes for higher ADU. On the left is a plot of the unbounded integral nonlinearity that grows progressively throughout the range of the CCD first sharply for low ADU then more gradually for higher ADU.}
    \label{fig:originalDNLINL}
\end{figure}

\subsection{Additional Tested Calibration Methods}
\label{sec:AdMethod}
We comment further on motivating a flat distribution being necessary for calibration.
Using a unscaled 13144 but the method described in section \ref{sec: AD}, cumulative binning, the ADC was calibrated depending on a starting bin.
This bin normally was taken to be the first ADU in the distribution from the run itself. 
Yet, one would believe that the DNL and INL would be independent of the location of the starting bin as it should be characterizing the nature of the ADC.
The analysis demonstrated this was not true of the INL, and rather the INL would behave very differently depending upon the choice of the first bin. 
We were able to force the INL to reach a maximum value of anywhere between 2 and 200 over the range of the ADC depending on the choice of starting bin.
Work as also done to look for a possible binary correlation between the starting bin and INL and found none was present. 
We also examined the relative values of the filter and the distribution itself for the starting bin, as well as their change, and found no correlation between the two. 
This effect was entirely removed for run 13549, and minimized for later starting bin, where the distribution was evenly represented, suggesting the INL issue was a result from the skewed original distribution. 
 \indent 
 
Extensive work was also done in order to choose the filter used in the cumulative sum binning method described in section \ref{sec: AD}. 
We examined multiple window sizes, between 25 and 100, and different orders of the filter, 2nd and 3rd for the Savitzky-Golay filter. 
We also utilized another type of filter, Butterworth with high-pass, lowpass, and bandpass. 
We utilized Chi-Squared tests in order to determine which filter best represented the input data and distributions, using both the real data used in this paper, but also fabricated datasets as well. 
The results demonstrated that the Savitzky-Golay filter with window size 33 and order 3, represented the data used in the analysis and the fabricated data very well, and was therefore chosen for use in the method. 
 \indent 

Work was also done to examine the convergence interval method that was used in the cumulative sum binning method. 
The method uses a convergence interval of $\pm$ specified value to converge on the right edge of the ADC bin. 
Through many iterations, it was found that while an increased precision in the value takes much more computation time, it does not positively impact the values of the DNL and INL seen in the distribution. 
Thus, the convergence interval of 1 count optimizes the computation time while still yielding a 0.2 percent difference between the observed counts and that achieved by the method. 
Another effort went into looking over the residual amount, either by the method going over or under the goal amount per bin, and whether some bias was present due to it. 
It was determined that the residuals make no noticeable pattern over the range of the ADC, and rather also suggests that the bins were not larger or smaller than expected. 
In addition, a test was conducted to add the residuals to the next bin throughout the method. 
This demonstrated no noticeable changes in the DNL, but a new structure emerged in the INL. 
These changes, coupled with 0.2 percent difference suggests the residuals were of a negligible amount and no more robust treatment of them is necessary. 
\indent 


Lastly there were various other attempts of calibration methods that were tried. 
Some of these include terminating the dataset and doing a DNL mean correction in the original method in section \ref{sec:Adrianmethod}. 
These methods both failed due to the other issues discussed throughout this work. 
Before creating the pre-scale method, we also tried adding a correction to the filtered output in order to more closely match the distribution. 
This proved to not fix the INL or the DNL problem, and diminished much of the filter's predictive power of acting as a true ADC distribution.
The last method we tried involved PDF as used in the cumulative cum binning method, but it did not utilize the cumulative sum. 
Rather it fit a spline to each of the filtered datapoints, which mathematically would require to deconvolve the PDF in order to recover the edges. 
This was replaced by the cumulative sum aspect of the method due to the complexities necessary finding the edge solutions in this method. 

\end{document}